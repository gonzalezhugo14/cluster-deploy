{% raw %}
    #
    # Node alerts (from kube-state-metrics / node-exporter)
    #
    # There are some alerts from https://github.com/kayrus/prometheus-kubernetes/tree/master/prometheus-rules
    - name: node-alerts
      rules:

      #
      # Alert on CPU > 75% on all nodes
      #
      - alert: NodeCPUUsage
        expr: (100 - (avg(irate(node_cpu{component="node-exporter",mode="idle"}[5m]))
          BY (instance) * 100)) > 75
        for: 2m
        labels:
          notify: sre
          severity: info
        annotations:
          summary: "{{ $labels.instance }}: High CPU usage is detected"
          description: "{{ $labels.instance }}: CPU usage is above 75% (current value is: {{ $value }})"

      #
      # Alert on load average > 1
      #
      - alert: NodeLoadAverage
        expr: ((node_load5 / count(node_cpu{mode="system"}) WITHOUT (cpu, mode)) > 1)
        for: 5m
        labels:
          notify: sre
          severity: info
        annotations:
          description: "{{ $labels.instance }}: Load average is high"
          summary: "{{ $labels.instance }}: High LA detected"

      #
      # Alert on swap > 75%
      #
      - alert: NodeSwapUsage
        expr: (((node_memory_SwapTotal - node_memory_SwapFree) / node_memory_SwapTotal)
          * 100) > 75
        for: 5m
        labels:
          notify: sre
          severity: info
        annotations:
          summary: "{{ $labels.instance }}: Swap usage is detected"
          description: "{{ $labels.instance }}: Swap usage usage is above 75% (current value is: {{ $value }})"

      #
      # Alert on memory > 75%
      #
      - alert: NodeMemoryUsage
        expr: (((node_memory_MemTotal - node_memory_MemFree - node_memory_Cached) / (node_memory_MemTotal)
          * 100)) > 75
        for: 5m
        labels:
          notify: sre
          severity: info
        annotations:
          summary: "{{ $labels.instance }}: High memory usage is detected"
          description: "{{ $labels.instance }}: Memory usage is above 75% (current value is: {{ $value }})"

      #
      # Disk is free < 25%
      #
      - alert: HighNodeDiskUsage
        expr: (avg(node_filesystem_avail{device=~"^/dev/[sv]da1$"}) BY (instance)) / (avg(node_filesystem_size{device=~"^/dev/[sv]da1$"})
          BY (instance)) * 100 < 25
        for: 5m
        labels:
          notify: sre
          severity: info
        annotations:
          summary: "{{$labels.instance}}: High disk usage is detected"
          description: "{{$labels.instance}}: Disk usage is above 75% (current value is: {{ $value }})"

      #
      # TODO: Disk will be busy after 4 hours
      # something like: predict_linear((avg by (instance) (node_filesystem_avail{device=~"^/dev/[sv]da1$"})), 4*3600) < 0

{% endraw %}
